<!DOCTYPE html>
<html>
<head>
    <title>아이돌 분류기~</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-JEW9xMcG8R+pH31jmWH6WWP0WintQrMb4s7ZOdauHnUtxwoG2vI5DkLtS3qm9Ekf"
            crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/dropzone/dist/dropzone.css"/>
    <link href="https://unpkg.com/cropperjs/dist/cropper.css" rel="stylesheet"/>
    <script src="https://unpkg.com/dropzone"></script>
    <script src="https://unpkg.com/cropperjs"></script>
    <link href="{{ url_for('static', path='/default.css') }}" rel="stylesheet">
    <style>


    </style>
</head>
<body>
<main>
    <div class="container" align="center" id="content">
        <br/>
        <h3 align="center">아이유, 아이린, 아린 사진을 올려주세요~~</h3>
        <br/>
        <div class="row">
            <div class="col-md-4"></div>
            <div class="col-md-4">
                <div class="image_area">
                    <label for="upload_image">
                        <img src="" id="uploaded_image" class="img-responsive"/>
                        <br>
                        <div class="btn btn-outline-secondary">이미지 가져오기~~~</div>

                        <input type="file" multiple accept="image/*" name="image" class="image" id="upload_image"
                               style="display:none"/>
                    </label>
                    <!--                    <br>-->
                    <br>
                    <div class="btn btn-primary" id="uploadImageServer">결과 확인~~~~~~~</div>

                </div>


            </div>


        </div>
        <hr>
        <div id="predictResult">
            예측 결과 :
        </div>
    </div>
</main>


<div class="modal fade" id="modal" tabindex="-1" role="dialog" aria-labelledby="modalLabel"
     aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">이미지 자르기(한 사람 얼굴만 포함되게~~)</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="img-container">
                    <div class="row">
                        <div class="col-md-8">
                            <img src="" id="sample_image"/>
                        </div>
                        <div class="col-md-4">
                            <div class="preview"></div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" id="crop" class="btn btn-primary">확인</button>
                <button type="button" class="btn btn-secondary" data-dismiss="modal">취소</button>
            </div>
        </div>
    </div>
</div>

</body>
</html>

<script>

    $(document).ready(function () {

        var $modal = $('#modal');

        var image = document.getElementById('sample_image');

        var cropper;

        $("#upload_image").click(function () {
            $("#upload_image").val("")
        });

        $('#upload_image').change(function (event) {
            var files = event.target.files;

            var done = function (url) {
                image.src = url;
                $modal.modal('show');
            };

            if (files && files.length > 0) {
                reader = new FileReader();
                reader.onload = function (event) {
                    done(reader.result);
                };
                reader.readAsDataURL(files[0]);
            }
        });

        $modal.on('shown.bs.modal', function () {
            cropper = new Cropper(image, {
                // aspectRatio: 1,
                viewMode: 0,
                initialAspectRatio: 1,
                preview: '.preview'
            });

        }).on('hidden.bs.modal', function () {
            cropper.destroy();
            cropper = null;
        });

        $('#crop').click(function () {
            canvas = cropper.getCroppedCanvas({
                width: 400,
                height: 400
            });

            canvas.toBlob(function (blob) {
                url = URL.createObjectURL(blob);
                var reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = function () {
                    var base64data = reader.result;
                    $("#uploaded_image").attr("src", base64data);
                    $modal.modal('hide');
                };
            });
        });

        $('#uploadImageServer').click(function () {
            let base64data = $("#uploaded_image").attr("src");

            $.ajax({
                url: './upload-image',
                method: 'POST',
                dataType: "json",
                data: JSON.stringify({image: base64data}),
                success: function (data) {
                    if ("result" in data) {
                        let result = data["result"]
                        $("#predictResult").html(`
                        예측 결과 : ${result["idol"]}
                        <br>
                        아이유 : ${result.percentage[0].toFixed(2)}%
                        <br>
                        아이린 : ${result.percentage[1].toFixed(2)}%
                        <br>
                        아린 : ${result.percentage[2].toFixed(2)}%
                        `)
                    } else {
                        $("#predictResult").html(`얼굴 하나만 잘라주세요ㅠ`)
                    }


                }
            });
        });


    });
</script>
